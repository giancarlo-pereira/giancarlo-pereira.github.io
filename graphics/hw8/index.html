<body bgcolor=#ffffff>
   <canvas id=textureCanvas1 width=512 height=512 style=position:absolute;left:-1000></canvas>
   <canvas id=textureCanvas2 width=512 height=512 style=position:absolute;left:-1000></canvas>
   <textarea id=textArea
         spellcheck=false
         rows="4"
         cols="30"
         minlength="10"
         maxlength="30"
         placeholder="Your thoughts here"
         style="position:absolute;left:-1000;font:16px courier;outline-width:0;border-style:none;resize:none;overflow:scroll;">
      </textArea>
   <center>
      <p>
         GIANCARLO PEREIRA HW8 -- TEXTURE MAPPING
      </p>
      <p>
         Type your thoughts into the thought bubble. Press <b>ENTER</b> to release that thought!<br>
         Once released, you can click on that thought to make it disappear.
      </p>
      <canvas id='canvas1' width=800 height=800></canvas>         
   </center>
</body>

<script src=lib.js></script>
<script>

texture(0, 'cloud_bump.jpg');
texture(1, 'wood_bump.jpg');
texture(2, textureCanvas1);    // NOTE: THIS IS AN HTML CANVAS BEING USED AS A TEXTURE SOURCE.
texture(3, textureCanvas2);
texture(4, 'wood_floorboard.jpg');

let thought = new Balloon();

// REPARSE THE TEXT AREA AFTER EVERY KEYSTROKE.
let lim = 120;
textArea.style.backgroundColor = '#202020';
textArea.style.color = 'white';

window.addEventListener("keydown", e => {
   if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight',
   'Delete', 'ShiftRight', 'ShiftLeft', 'Tab', 'ControlRight',
   'ControlLeft', 'AltLeft', 'AltRight', 'Escape', 'CapsLock',
   'MetaLeft', 'MetaRight'].indexOf(e.code) >= 0)
      e.preventDefault();
   else if (['Space', 'Enter'].indexOf(e.code) >= 0) {
      e.preventDefault();
      textArea.onkeydown(e);
   }
   else textArea.onkeydown(e);
});

let sendThought = (text) => {
   console.log(`sending message... ${text}`);
   thought.trigger();
} 

let explosion = t => {
   let c = [.7,.7,.7];
   let move = .05*(Math.random() - .5)
   for ( var i = 0; i < 100; i++ ) {
      M.S().move(Math.random()-.5,Math.random()-.5,0).scale(.01).draw(Sphere(10),c,.9, -1, -1).R()
   }
}

textArea.onkeydown = function(e) {
   if (e.code === 'Enter')  {
         if (this.value.length > 0 )  
         sendThought(this.value);
      }
   else if (e.code === 'Backspace') this.value = this.value.slice(0,-1);
   else {
      if (this.value.length < 120)
      this.value += e.key;
   }
}

function drawFrame() {
   requestAnimationFrame(drawFrame);
   let t = Date.now() / 1000;

   // CHANGE THE CONTENT OF THE 2D CANVAS EVERY ANIMATION FRAME.

   let ctx = textureCanvas1.getContext('2d');
   ctx.fillStyle = '#ffd0d0';
   ctx.fillRect(0, 0, 512, 512);
   ctx.fillStyle = 'black';
   ctx.font = '100px Arial';
   let minutes = (t/60>>0)%60, seconds = t%60>>0;        // FORMAT TIME TO MINUTES & SECONDS.
   ctx.fillText(minutes + 'm ' + seconds + 's', 60, 280);

   ctx = textureCanvas2.getContext('2d');
   ctx.fillStyle = '#ededed';
   ctx.fillRect(0, 0, 512, 512);
   ctx.fillStyle = 'black';
   ctx.font = '25px Arial';
   ctx.fillText(textArea.value, 0, 250);

   M.S().perspective(fl);
      if (thought.hit(cursor)) {
         console.log(`thought shot down`);
         textArea.value = ``;
         explosion(t);
      }

      //walls
      M.S().move(0, 0,-2*fl).scale(10).turnY(    0).draw(Square()    , [.2,.7,1]   , 1,  -1, -1).R();
      M.S().move(-2,0,    0).scale(10).turnY( pi/2).draw(Square()    , [.2,.7,1]   , 1,  -1, -1).R();
      M.S().move(+2,0,    0).scale(10).turnY( pi/2).draw(Square()    , [.2,.7,1]   , 1,  -1, -1).R();

      //floor
      M.S().move(0,-2,    0).scale(10).turnX(-pi/2).draw(Square()    , [.1,.1,1]   , 1,  4, 1).R();

      thought.fly(t);
      thought.render(t,3,-1);
      // M.S().move(-.6, .3,0).turnY( t).scale(.2).draw(Tube(30)    , [1,1,1]   , 1,  0   ).R();
      // M.S().move(  0, .3,0).turnY( 0).scale(.2).draw(Sphere(30)  , [1,1,0]   , 1,      ).R();
      // M.S().move( .6, .3,0).turnY( t).scale(.2).draw(Cylinder(30), [1,1,1]   , 1,  0   ).R();
      // M.S().move(-.6,-.3,0).turnX(-t).scale(.2).draw(Cube()      , [1,1,1]   , 1,  1   ).R();
      // M.S().move( .6,-.3,0).turnY(-t).scale(.2).draw(Torus(30)   , [1,.5,.3] , 1, -1, 3).R();
      M.S().move(  -.5,.5,0).turnX( t).scale(.2).draw(Cube()      , [1,1,1]   , 1,  2,-1).R();
      // M.S().move(0,.3,.5).turnY( t).scale(.2).draw(Square()      , [1,1,1]   , 1,  2,-1).R();
   M.R();
}
requestAnimationFrame(drawFrame);

</script>
